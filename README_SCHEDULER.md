# Chatbox 定时任务功能

## 功能概述

定时任务功能允许用户创建可重复执行的 AI 对话任务，支持多种调度方式和输出配置。

## 主要特性

### 1. 灵活的调度方式
- **间隔执行**: 支持分钟、小时、天、周为单位的间隔执行
- **Cron 表达式**: 支持复杂的时间调度规则
- **一次性任务**: 支持在指定时间执行一次

### 2. AI 模型集成
- 支持所有现有的 AI 提供商（OpenAI、Anthropic、Google、Azure 等）
- 可配置不同的模型参数
- 集成 MCP (Model Context Protocol) 服务器

### 3. 会话集成
- **自动保存**: 任务执行结果自动保存到新的会话中
- **会话管理**: 每次执行都会创建独立的会话记录

### 4. 任务监控
- 实时执行状态监控
- 详细的执行历史记录
- 性能统计和成功率分析

## 快速开始

### 1. 安装依赖

确保已安装新增的依赖包：

```bash
npm install cron react-hook-form
```

### 2. 启动应用

```bash
npm run dev
```

### 3. 访问定时任务

在应用中导航到 "定时任务" 页面，或直接访问 `/scheduler` 路由。

## 使用指南

### 创建任务

1. 点击 "创建任务" 按钮
2. 填写任务基本信息：
   - 任务名称
   - 任务描述（可选）
   - 启用状态

3. 配置 AI 设置：
   - 选择 AI 提供商
   - 输入模型名称
   - 编写提示词
   - 选择 MCP 服务器（可选）

4. 设置调度规则：
   - **间隔执行**: 设置数值和时间单位
   - **Cron 表达式**: 输入标准 Cron 表达式
   - **一次性任务**: 选择执行时间

5. 任务将自动保存执行结果到新的会话中

### 管理任务

- **启用/禁用**: 使用开关控制任务状态
- **编辑任务**: 点击编辑按钮修改任务配置
- **查看详情**: 点击查看按钮查看执行历史
- **删除任务**: 点击删除按钮移除任务

### 监控执行

- **实时状态**: 任务卡片显示当前执行状态
- **执行历史**: 查看详细的执行记录和结果
- **统计信息**: 查看任务总数、成功率等统计数据

## 技术架构

### 主进程组件

- **TaskScheduler**: 核心调度器，管理任务生命周期
- **TaskExecutor**: 任务执行器，处理 AI 对话和结果输出
- **TaskStorage**: 数据持久化，管理任务和执行记录存储

### 渲染进程组件

- **ScheduledTasksPage**: 主页面组件
- **TaskList**: 任务列表展示
- **TaskModal**: 任务创建/编辑对话框
- **TaskMonitor**: 执行监控面板
- **TaskStatsCards**: 统计信息卡片

### 数据流

1. 用户在 UI 中创建/修改任务
2. 渲染进程通过 IPC 与主进程通信
3. 主进程调度器管理任务执行
4. 执行结果通过事件系统实时更新 UI

## 配置示例

### 间隔执行任务

```json
{
  "name": "每日新闻摘要",
  "prompt": "请为我总结今天的重要新闻",
  "schedule": {
    "type": "interval",
    "interval": {
      "value": 1,
      "unit": "days"
    }
  },

}
```

### Cron 表达式任务

```json
{
  "name": "工作日提醒",
  "prompt": "提醒我今天的工作重点",
  "schedule": {
    "type": "cron",
    "cron": "0 0 9 * * 1-5",
    "timezone": "Asia/Shanghai"
  },

}
```

## 故障排除

### 常见问题

1. **任务不执行**
   - 检查任务是否启用
   - 验证调度配置是否正确
   - 查看主进程日志

2. **MCP 服务器连接失败**
   - 确认 MCP 服务器配置正确
   - 检查服务器进程是否运行
   - 查看错误日志

3. **文件导出失败**
   - 检查导出路径是否存在
   - 确认应用有写入权限
   - 验证磁盘空间是否充足

### 日志查看

主进程日志位置：
- Windows: `%APPDATA%\xyz.chatboxapp.ce\logs\`
- macOS: `~/Library/Logs/xyz.chatboxapp.ce/`
- Linux: `~/.config/xyz.chatboxapp.ce/logs/`

## 开发指南

### 添加新的调度类型

1. 在 `TaskSchedule` 类型中添加新的调度类型
2. 在 `TaskScheduler.scheduleTask()` 中实现调度逻辑
3. 在 UI 中添加相应的配置选项

### 扩展输出格式

1. 在 `TaskOutputConfig` 中添加新的格式选项
2. 在 `TaskExecutor.exportToFile()` 中实现格式化逻辑
3. 在任务配置 UI 中添加格式选择

### 集成新的 AI 提供商

1. 确保 AI 提供商已在现有系统中配置
2. 在任务配置中添加提供商选项
3. 测试任务执行和结果处理

## 安全考虑

- 任务配置和执行记录存储在本地
- 不会上传用户的提示词和执行结果
- MCP 服务器连接使用安全的进程间通信
- 文件导出路径限制在用户目录内

## 性能优化

- 任务执行使用独立的执行器，不阻塞主线程
- 执行历史自动清理，避免数据积累过多
- UI 使用虚拟化列表处理大量任务
- 实时事件使用防抖处理，减少 UI 更新频率

## 未来规划

- [ ] 任务模板和预设
- [ ] 任务执行条件和依赖
- [ ] 更多输出目标（邮件、Webhook 等）
- [ ] 任务执行统计和分析
- [ ] 任务分组和标签管理
- [ ] 导入/导出任务配置